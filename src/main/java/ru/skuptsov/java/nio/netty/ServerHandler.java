package ru.skuptsov.java.nio.netty;

import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelFutureListener;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

/**
 * @author Sergey Kuptsov
 * @since 03/12/2016
 */
public class ServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelActive(final ChannelHandlerContext ctx) {
        String message = "HTTP/1.1 200 OK\r\n" +
                "Content-Length: 7715\r\n" +
                "Content-Type: text/html\r\n" +
                "\r\n" +
                "<!DOCTYPE html><html><head><script>var _data={\"data\":{\"locationInfo\":{\"type\":\"LBS\",\"changedAt\":\"2016-10-23T21:40:15.448Z\",\"location\":{\"latitude\":55.815436299999995,\"longitude\":37.6206555},\"nearestCityId\":18958,\"boundCityId\":18950},\"currentUser\":{\"result\":{\"userId\":\"486703890188732520\",\"baseProfileInfo\":{\"id\":\"486703890188732520\",\"surname\":\"Купцов\",\"name\":\"Сергей\",\"nickname\":\"sergey\",\"sex\":\"FEMALE\",\"residence\":{\"id\":18990,\"name\":\"Zamoskvorech'ye\",\"region\":{\"id\":2780,\"name\":\"Moscow\"},\"country\":{\"id\":58,\"name\":\"Russia\",\"isoCode\":\"ru\"}},\"accountType\":\"VIP\",\"age\":28,\"currentCity\":{\"id\":18958,\"name\":\"Ostankinskiy\",\"region\":{\"id\":2780,\"name\":\"Moscow\"},\"country\":{\"id\":58,\"name\":\"Russia\",\"isoCode\":\"ru\"}},\"onlineState\":\"ONLINE\",\"stateChangedAt\":\"2016-10-23T21:42:05.662Z\",\"connectionType\":\"WEB\",\"avatarStorageId\":\"312837445391486976\",\"hasAvatar\":true,\"userState\":\"ACTIVE\",\"distance\":0.0,\"birthDate\":\"1988-01-01\",\"email\":\"kuptservol@ya.ru\",\"phone\":null,\"interfaceLanguage\":{\"id\":2,\"code\":\"language.en\",\"locale\":\"en\"},\"properties\":{\"BROWSER_CHAT_NOTIFICATION\":false,\"PUSH_DEVICE_GUEST_NOTIFICATION\":true,\"HEIGHT_MEASUREMENTS\":\"CENTIMETERS\",\"PUSH_DEVICE_FIRST_CONTACT_NOTIFICATION\":false,\"HIDE_GUESTS_PRESENCE\":false,\"PUSH_DEVICE_SEND_AT_DAY_ONLY\":true,\"PUSH_EMAIL_FIRST_CONTACT_NOTIFICATION\":false,\"PUSH_DEVICE_CHAT_NOTIFICATION\":true,\"PREMIUM_SETTINGS\":{\"hideSitePresence\":false,\"hideGuestsPresence\":false},\"PUSH_DEVICE_OTHER_NOTIFICATION\":true,\"PUSH_DEVICE_CHAT_MESSAGE_TEXT\":true,\"SEARCH_PRESET\":{\"ageFrom\":24,\"ageTo\":39,\"sex\":\"FEMALE\",\"city\":{\"id\":18990,\"name\":\"Zamoskvorech'ye\",\"region\":{\"id\":2780,\"name\":\"Moscow\"},\"country\":{\"id\":58,\"name\":\"Russia\",\"isoCode\":\"ru\"}},\"country\":null,\"heightFrom\":null,\"heightTo\":null,\"heightMeasurement\":\"CENTIMETERS\",\"weightFrom\":null,\"weightTo\":null,\"weightMeasurement\":\"KILO\",\"bodyTypes\":null,\"weedHabits\":null,\"smokingHabits\":null,\"drinkingHabits\":null,\"maritalStatuses\":null,\"educations\":null,\"incomes\":null,\"religiousViews\":null,\"interests\":null,\"languages\":null,\"professions\":null},\"PUSH_EMAIL_CHAT_NOTIFICATION\":true,\"PUSH_EMAIL_OTHER_NOTIFICATION\":false,\"PUSH_EMAIL_GUEST_NOTIFICATION\":false,\"WEIGHT_MEASUREMENTS\":\"KILO\",\"HIDE_SITE_PRESENCE\":false,\"RECENT_CHAT_FOLDER_ID\":\"3\",\"SEND_MESSAGE_KEY\":\"ENTER\"},\"deletedAt\":null,\"willCompletelyDeletedAt\":null,\"baseFieldsModified\":true,\"avatarCandidateStorageId\":null},\"advancedProfileInfo\":{\"height\":175,\"heightMeasurement\":\"CENTIMETERS\",\"weight\":67.0,\"weightMeasurement\":\"KILO\",\"profession\":null,\"bodyType\":{\"id\":3,\"code\":\"body.type.athletic\"},\"weedHabit\":null,\"smokingHabit\":null,\"drinkingHabit\":{\"id\":3,\"code\":\"drinking.social\"},\"maritalStatus\":null,\"education\":null,\"income\":null,\"religiousView\":{\"id\":10,\"code\":\"religion.atheism\"},\"languages\":null},\"subscriptionProfileInfo\":{\"followersCount\":33,\"followingsCount\":82,\"friendsCount\":20,\"postsCount\":30,\"isFollow\":false},\"avatar\":{\"id\":\"610907868467562501\",\"storageId\":\"312837445391486976\",\"userComment\":null,\"photoState\":\"NEW\",\"activityId\":\"610907868534671366\"},\"avatarCandidate\":null,\"keyFields\":{\"userId\":\"486703890188732520\",\"name\":\"Сергей\",\"surname\":\"Купцов\",\"birthDate\":\"1988-01-01\",\"sex\":\"FEMALE\",\"residence\":{\"id\":18990,\"name\":\"Zamoskvorech'ye\",\"region\":{\"id\":2780,\"name\":\"Moscow\"},\"country\":{\"id\":58,\"name\":\"Russia\",\"isoCode\":\"ru\"}},\"login\":\"kuptservol@ya.ru\",\"type\":\"EMAIL\",\"validated\":true,\"termsAccepted\":true},\"wishes\":[],\"joinedSocialTypes\":[\"VK\"],\"bannedByCurrent\":false,\"bannedCurrent\":false,\"folderId\":null,\"balance\":68000,\"currency\":\"RUB\",\"authorities\":[\"ACTIVE\",\"EDIT_PROPERTIES\",\"LOAD_OWN_PROFILE\",\"MODERATOR\",\"ORDINAL\",\"WEB_SOCKET\"],\"interests\":[\"лето\",\"москва\",\"утро\",\"счастливая\",\"жизньпрекрасна\",\"me\",\"girl\",\"романтика\",\"момент\",\"life\"],\"vipSettings\":{\"state\":\"UNSUBSCRIBED\",\"validUntil\":\"2017-07-04T16:35:09.560Z\",\"stateChangedAt\":\"2016-05-04T16:35:09.492Z\",\"paymentSystem\":\"ANDROID\"}}},\"counters\":[],\"profile.accessModeration\":true,\"ip.resolved.city\":{\"id\":18950,\"name\":\"Moscow\",\"region\":null,\"country\":{\"id\":58,\"name\":\"Russia\",\"isoCode\":\"ru\"}}},\"metaData\":{\"upload.url\":\"https://mdfs-1.myfriends.com/photos\",\"mdfs.public.url\":\"https://cdn-1.myfriends.com/\",\"mdfs.private.url\":\"https://mdfs-1.myfriends.com/storage/private/\",\"payment.xsolla.paystation.url\":\"https://secure.xsolla.com/paystation2/\",\"regionalSettings\":{\"socialTypes\":[\"FACEBOOK\",\"VK\",\"ODNOKLASSNIKI\",\"INSTAGRAM\",\"TWITTER\",\"GOOGLE\",\"LINKEDIN\"],\"registrationTypes\":[\"PHONE\"]},\"presets.age\":{\"from\":24,\"to\":39},\"wishTypes\":[{\"id\":1,\"code\":\"wish.type.event\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}},{\"id\":2,\"code\":\"wish.type.coffee\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}},{\"id\":3,\"code\":\"wish.type.sport\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}},{\"id\":4,\"code\":\"wish.type.walk\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}},{\"id\":5,\"code\":\"wish.type.eat\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}},{\"id\":6,\"code\":\"wish.type.drink\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}},{\"id\":7,\"code\":\"wish.type.cinema\",\"group\":{\"id\":1,\"code\":\"wish.common.type.all\"}}],\"timeZoneInfo\":{\"serverTime\":\"2016-10-23T21:42:06.637Z\",\"userTimeZoneOffset\":10800000},\"wishExpirationTypes\":[{\"id\":1,\"cron\":\"0 0 2 ? * *\",\"code\":\"wish.expiration.type.today\",\"offsetSeconds\":0},{\"id\":2,\"cron\":\"0 0 2 ? * *\",\"code\":\"wish.expiration.type.tomorrow\",\"offsetSeconds\":86400},{\"id\":3,\"cron\":\"0 0 2 ? * MON\",\"code\":\"wish.expiration.type.week\",\"offsetSeconds\":0}],\"localization.language\":\"en\",\"localization.version\":\"2323927779692822592\",\"comment.editable.response.seconds\":600,\"comment.maximum.length\":500,\"max.user.folders.count\":10,\"user.location.update.response.seconds\":900,\"user.ping.update.response.seconds\":5,\"locale.languages\":[{\"id\":2,\"code\":\"language.en\",\"locale\":\"en\"},{\"id\":3,\"code\":\"language.ru\",\"locale\":\"ru\"},{\"id\":4,\"code\":\"language.es\",\"locale\":\"es\"},{\"id\":5,\"code\":\"language.pr\",\"locale\":\"pt\"},{\"id\":6,\"code\":\"language.it\",\"locale\":\"it\"},{\"id\":7,\"code\":\"language.fr\",\"locale\":\"fr\"},{\"id\":8,\"code\":\"language.de\",\"locale\":\"de\"},{\"id\":9,\"code\":\"language.ch\",\"locale\":\"zh-chs\"},{\"id\":10,\"code\":\"language.cht\",\"locale\":\"zh-cht\"},{\"id\":11,\"code\":\"language.jp\",\"locale\":\"ja\"},{\"id\":12,\"code\":\"language.kr\",\"locale\":\"ko\"}],\"client.logs.enabled\":false,\"captcha.site.key\":\"6Lf4QwsTAAAAAGr_Voeb5v6QnO8Gfqol0kQl9N3Y\",\"gift.rotation.period.in.seconds\":10,\"gift.rotation.count\":50,\"chat.message.max.photo.count\":1,\"recommended.feed.id\":\"51:0:18950:0\",\"delete.profile.reasons\":[\"FAMILY_REASON\",\"DONT_APPRECIATE\",\"RUDE\",\"LOT_OF_ADS\",\"OTHER\"],\"mobile.application.urls\":{\"urls\":{\"IOS_IPHONE\":\"https://itunes.apple.com/ru/app/myfriends-app/id983178396\",\"IOS_IPAD\":\"https://itunes.apple.com/ru/app/myfriends-app/id983178396\",\"ANDROID_PHONE\":\"https://play.google.com/store/apps/details?id=com.myfriends.myfriendsandroid\",\"ANDROID_TABLET\":\"https://play.google.com/store/apps/details?id=com.myfriends.myfriendsandroid\"}},\"upload.photo.min.size\":200,\"upload.photo.max.size\":1200,\"push.in.app.enabled\":true,\"push.in.app.delay.ms\":1000,\"fields.additional.limits\":{\"heightMinFt\":4.7,\"heightMaxFt\":7.1,\"heightMinCm\":140,\"heightMaxCm\":240,\"weightMinKg\":40.0,\"weightMaxKg\":240.0,\"weightMinLb\":88.0,\"weightMaxLb\":528.0},\"contest\":{\"enabled\":true,\"start\":\"2016-09-26T00:00:00.000Z\",\"finish\":\"2016-10-14T12:00:00.000Z\",\"contestUrl\":\"https://contest.myfriends.com\"},\"giphy\":{\"key\":\"dc6zaTOxFJmzC\",\"url\":\"http://api.giphy.com/\"},\"client.statistics.gateways.list\":[\"https://collector1-us-east.kama.gs:5500\",\"https://collector1-us-west.kama.gs:5500\",\"https://collector1-eu-west.kama.gs:5500\",\"https://collector1-eu-central.kama.gs:5500\"],\"comet.client.history.period.seconds\":600,\"facebook.app.id\":\"266830326813160\"}};var _timeStartPage = +new Date();</script><meta name=\"viewport\" content=\"width=1280px\"></body></html>";

        final ByteBuf response = ctx.alloc().buffer(message.length() * 2);
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        response.writeBytes(message.getBytes());

        final ChannelFuture f = ctx.writeAndFlush(response);
        f.addListener(new ChannelFutureListener() {
            @Override
            public void operationComplete(ChannelFuture future) {
                assert f == future;
                ctx.close();
            }
        });
    }
}